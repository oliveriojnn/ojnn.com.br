name: Deploy ojnn.com.br
on:
  push:
    branches:
      - main
jobs:
  setup-build-publish-deploy:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Auth GCP
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
    - name: Configure Docker
      run: |
          gcloud auth configure-docker gcr.io
    - name: Build & Publish
      run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud builds submit --tag us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.GCP_APPLICATION }}/ojnn:${{ github.sha }}
          gcloud builds submit --tag us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.GCP_APPLICATION }}/ojnn:latest
    - name: Update values
      run: |
          sed -i 's/version: .*/version: "${{ github.sha }}"/' Chart/values-staging.yaml
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Chart/values.yaml
          git commit -m "chore: update staging image to ${{ github.sha }} [skip ci]" || echo "No changes"
          git push || echo "No push needed"
